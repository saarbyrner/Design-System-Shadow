# 001. Adding Constraints to entites

## Date: 08 Feb 2023

## Status: Accepted

## Context:

For player movement as part of the NFL go live, entities needed to be locked
down and access restricted when

- the entity was not created in the current organisation
  - In the case of injuries/illnesses, vaccinations, medical notes;
    - the minimum date an entity could be created is 24 hours after the athlete
      has joined the current organisation
    - the maximum date an entity could be created is the date of transfer if the
      athlete has left the organisation
  - in the case of an athlete, certain actions needed to be restricted if the
    athlete was not longer in the organisation
  - Adding an allergy is not longer possible
  - Creating a medical alert is not longer possible

Due to tight deadlines and the volume of work required, a decision was made to
return the last transfer record for the athlete within the context of the
current org requesting it. Using this record, date restrictions could be applied
to date pickers that will work with the constraints of the transfer record.

Initially, we were awre of the problems this would cause:

- it doesn't allow for an athlete moving from ORG A -> ORG B -> ORG A as only
  the last transfer record was considered
- We were returning values from the BE that were used to derive permissions in
  the FE rather than simply return a flag identifiying the actions allowed

The proposal is to create a `Constraints` object in the BE, that can be applied
to an `Athlete` or an `Entity` and use the values returned to display available
values or impose restrictions, instead of deriving in the FE.

The proposal is the object would be structured as follows

At the athlete level:

```
  {
    ...athleteData,
    constraints: {
      active_periods: [
        {
          start: timestamp,
          end: timestamp,
        },
        ...,
      ],
      organisation_status: 'PAST_ATHLETE' | 'CURRENT_ATHLETE' | 'TRANSFER_PENDING' | 'TRIAL_ATHLETE',
    }
  }
```

At the entity level:

```
  {
    ...entityData,
    constraints: {
      read_only: true | false,
    }
  }
```

This way we are no longer returning data to derive what actions are available to
the user, but rather the restrictions imposed.

## Decision:

We will implement the Constraints object for EMR entites and Athlete medical
records

## Consequences:

- BE work will be required to create the new constraints object and return in
  the responses for EMR data
- FE work will be required to replace the areas in the side panels where logic
  has been applied using the org_last_transfer_record with the new values passed
