# 002. File Uploads and File Titling

## Date: 15 Mar 2023

## Status: Accepted

## Context:

Initially it started out with giving the user an option to change a filename
(rename) during the upload process for if they wanted to make it smaller or more
specific to their needs.

The next stage was giving the ability to add a Title to the file to give a
specific name to a document entity. Document/file entities could have different
titles or share the same one if warranted.

### The criteria for this work involved:

- If feature flag is turned on, the user will have the ability to title files
- The title will default to the file name
- The user can edit the title
- The user can not leave the title blank
- A red box around it will appear if they click save and the title is blank
- The user can upload multiple files at once with multiple different titles
- The user can upload multiple files at once with the same title
- **This should affect all areas within product where the file component is**
- The title should appear on the documents flow
- The title should not appear anywhere else within the product (yet)

### Affecting all the Areas

Now initially I started work within the Note/Documents flow as that was the prio
but the rest of the work was seperated into multiple PR's to not overload
reviewers and make it easier for myself to work and progress.

The criteria **This should affect all areas within product where the file
component is** proved to be a bit difficult due to the fact that where the
original FileUploadField component was used there was also a large amount of
reduplicated html as well as different css containers which conflicted with the
title work I had done.

The component **FileUploadArea** was created with the intention to simplify the
wrapper/container and all scenarios where the FileUploadField was used in the
app with one css pattern of handling the vast majority of scenarios.

With this work there was some refactoring in some areas where we had a
reduplicated pattern of transforming file attachments into data objects to be
stored on the backend. I moved these into a util fileHelper.js to reduce the
amount of duplicated types throughout the app and keep it more consistent
rather.

```
export type AttachedFile = {
  filename: string,
  fileType: string,
  fileSize: number,
  fileTitle?: string,
  file: File,
  id: number,
  filenameWithoutExtension: string,
};

export type AttachedTransformedFile = {
  original_filename: string,
  filetype: string,
  filesize: number,
  name?: string,
};

export const transformFilesForUpload = (
  attachedFiles: AttachedFile[]
): AttachedTransformedFile[] =>
  attachedFiles.map(file => ({
    original_filename: file.filename,
    filetype: file.fileType,
    filesize: file.fileSize,
    name: file.fileTitle,
  }));
```

This also served to handle the new title field stored in name which the backend
would and **will** accept.

### Invalid Empty Titles

To accommodate **A red box around it will appear if they click save and the
title is blank**, a new util function was created under fileHelper.js

```
export const checkInvalidFileTitles = (attachedFiles: AttachedFile[]) =>
  window.featureFlags['files-titles'] &&
  attachedFiles.some(file => file.fileTitle === '');
```

This util function is used in all the areas where the user hits save on any of
the forms the FileUploadArea/Field has been implemented with these changes. If
the feature flag is turned off then everything works as normal but if the
feature flag is turned on and the user has attached files without a title, then
it should prevent the user from saving and firing off api calls.

### Misc Refactors

Other work done in the app is in scenarios like Add Issue/Additional
information, Add annotation and Add Treatment Session (in athlete availability),
we were converting the data in the **File** type object into a Json string to be
able to store in redux as redux has a issue/error with non-serializable values.
The issue with doing a flat conversion like json.stringify was it showed and
displayed the file object as a empty {} whenever console logged out or viewed in
the redux state, and there was no reconversion of the data before being sent up
to S3. To make it easier to work with I moved the areas to use more local state,
and changed so we passed strings/numbers into the redux dispatches compared to
trying to move the File object around.

Another refactor amongst this work included moving the position of the
attachments button and FileUploadArea in diagnosis overview when editing the
medical note card. Prior to this change the user had a narrow area to click and
view the files as it was on the right hand side of the page. This was moved to
the left under the medical notes area to give the user a easier time viewing and
changing file information.

The only areas this work has not been applied to so far is the live chat areas,
and the rehab treatment modal as that area is not currently being used in the
application.

## Decision:

We will apply the FileUploadArea and respective new changes to any usage of the
file component so it is readily accessible if required (except for the live chat
area).

## Consequences:

Backend will need to tweak various end points to make sure that they can accept
an attachment title and as some only take attachment ID's there will have to be
some tweaks to allow this information to be passed back to medinah.

**List of endpoints that require change to accept the title parameter**

- /medical/notes
- /medical/document_v2s/bulk_create
- /treatment_sessions
- /annotations
- Create /illnesses, /injuries, chronic issue
- /medical/notes/${annotationableId}
- /athletes/${athleteId}/medical_notes
- /concussion/king_devick, /concussion/npc
- /athletes/${athleteId}/diagnostics
- /medical/diagnostics/${diagnosticId}/attach
- /medical/procedures/bulk_create
- /medical/procedures/${procedureId}
- /medical/procedures/${procedureId}/attach
- /ui/planning_hub/events/${eventId}/event_activities/${activityId}/event_activity_drills

## References:

- https://github.com/KitmanLabs/projects/issues/31136
- https://github.com/KitmanLabs/kitman-frontend/pull/2846
- https://github.com/KitmanLabs/kitman-frontend/pull/2864
- https://github.com/KitmanLabs/kitman-frontend/pull/2898
- https://github.com/KitmanLabs/kitman-frontend/pull/2954
